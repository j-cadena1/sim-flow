# SSL/TLS Overlay for SimRQ DEVELOPMENT Environment
# Adds native HTTPS support for dev environment running side-by-side with prod
#
# Usage:
#   docker compose -p sim-rq-dev -f docker-compose.dev.yaml -f docker-compose.ssl-dev.yaml up -d
#
# Or use the Makefile:
#   make dev-ssl
#
# Required environment variables (set in .env):
#   DEV_SSL_DOMAIN=simrq-dev.example.com   # Dev domain (becomes certificate CN)
#   SSL_EMAIL=admin@example.com             # Email for Let's Encrypt notifications
#   CLOUDFLARE_API_TOKEN=xxx                # Cloudflare API token with DNS edit permissions
#
# Optional environment variables:
#   DEV_SSL_DOMAIN_ALIASES=a.com,b.com     # Additional dev domains (SANs)
#   LETSENCRYPT_STAGING=true               # Use Let's Encrypt staging (for testing)
#
# Note: This uses a separate certificate volume (sim-rq-dev-certs) from production

services:
  # Certbot container for dev SSL certificates
  certbot:
    build:
      context: .
      dockerfile: Dockerfile.certbot
    image: sim-rq-certbot:latest
    container_name: sim-rq-certbot-dev
    environment:
      # Use DEV_SSL_DOMAIN for dev environment
      SSL_DOMAIN: ${DEV_SSL_DOMAIN}
      SSL_DOMAIN_ALIASES: ${DEV_SSL_DOMAIN_ALIASES:-}
      SSL_EMAIL: ${SSL_EMAIL}
      CLOUDFLARE_API_TOKEN: ${CLOUDFLARE_API_TOKEN}
      LETSENCRYPT_STAGING: ${LETSENCRYPT_STAGING:-false}
    volumes:
      - sim-rq-dev-certs:/etc/letsencrypt
    healthcheck:
      test: ["CMD", "test", "-f", "/etc/letsencrypt/.ready"]
      interval: 10s
      timeout: 5s
      retries: 60
      start_period: 120s
    restart: unless-stopped
    networks:
      - sim-rq-dev-network
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # Override frontend service for dev SSL
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.ssl
      args:
        NODE_VERSION: ${NODE_VERSION:-20}
        NGINX_VERSION: ${NGINX_VERSION:-alpine}
    image: sim-rq-frontend-ssl:dev
    container_name: sim-rq-frontend-ssl-dev
    environment:
      SSL_DOMAIN: ${DEV_SSL_DOMAIN}
    ports:
      # Use alternate ports for dev to avoid conflict with prod SSL
      - "8443:443"
      - "8080:80"
    volumes:
      - sim-rq-dev-certs:/etc/letsencrypt:ro
    depends_on:
      certbot:
        condition: service_healthy
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "--no-check-certificate", "https://localhost/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 15s
    restart: unless-stopped
    networks:
      - sim-rq-dev-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  # Separate certificate volume for dev (doesn't conflict with prod)
  sim-rq-dev-certs:
    name: sim-rq-dev-certs
